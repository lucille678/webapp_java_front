<div class="editor" *ngIf="config">
  <h1>{{ config.title }}</h1>

  <form (ngSubmit)="onSubmit()">

    <div *ngFor="let section of config.sections" class="section">
      <button type="button" class="section-toggle" (click)="section.open = !section.open">
        {{ section.label }}
        <span>{{ section.open ? 'â–²' : 'â–¼' }}</span>
      </button>

      <div class="section-content" *ngIf="section.open">
        <!-- Section NON rÃ©pÃ©table -->
        <ng-container *ngIf="!section.repeatable">
          <div *ngFor="let field of section.fields" class="field">
            <label>{{ field.label }}</label>

            <!-- Champ texte/email -->
            <input *ngIf="field.type === 'text' || field.type === 'email'"
                   [type]="field.type"
                   [(ngModel)]="formData[section.name][field.name]"
                   [name]="section.name + '_' + field.name">

            <!-- Champ textarea -->
            <textarea *ngIf="field.type === 'textarea'"
                      [(ngModel)]="formData[section.name][field.name]"
                      [name]="section.name + '_' + field.name"></textarea>

            <!-- Champ fichier -->
            <div *ngIf="field.type === 'file'" class="file-field">
              <input type="file"
                     [id]="section.name + '_' + field.name"
                     (change)="onFileChange($event, section.name, field.name)"
                     [accept]="field.name === 'photo' ? 'image/*' : 'image/*,.pdf'">
              
              <!-- Preview avec bouton de suppression -->
              <div class="file-preview" *ngIf="getFieldValue(section.name, field.name)?.content">
                <img *ngIf="isImage(getFieldValue(section.name, field.name))"
                     [src]="getFieldValue(section.name, field.name).content"
                     [alt]="field.label">
                <div *ngIf="isPDF(getFieldValue(section.name, field.name))"
                     class="pdf-preview">PDF uploaded</div>
                <button type="button" class="remove-file" 
                        (click)="removeFile(section.name, field.name)">
                  âœ•
                </button>
              </div>
            </div>

            <!-- PrÃ©visualisation image -->
            <img *ngIf="formData[section.name][field.name]?.type?.startsWith('image/')"
                 [src]="formData[section.name][field.name]?.content"
                 alt="AperÃ§u"
                 style="max-width: 150px; margin-top: 10px; border-radius: 8px;">

            <!-- AperÃ§u PDF -->
            <div *ngIf="formData[section.name][field.name]?.type === 'application/pdf'"
                 class="pdf-preview">
              <span>{{ formData[section.name][field.name]?.name }}</span>
              <a [href]="formData[section.name][field.name]?.content" download>ðŸ“„ TÃ©lÃ©charger</a>
            </div>
          </div>
        </ng-container>

        <!-- Section RÃ‰PÃ‰TABLE -->
        <ng-container *ngIf="section.repeatable">
          <div *ngFor="let item of formData[section.name]; let i = index" class="repeatable-item">
            <div *ngFor="let field of section.fields" class="field">
              <!-- Champs normaux -->
              <ng-container *ngIf="field.type !== 'file'">
                <label>{{ field.label }}</label>
                
                <!-- Champs date pour Formation et ExpÃ©rience -->
                <ng-container *ngIf="section.name === 'formation' || section.name === 'experience'">
                  <div class="date-range" *ngIf="field.name === 'dates'">
                    <div class="field">
                      <label>Date de dÃ©but</label>
                      <input type="date" 
                             [(ngModel)]="item.startDate"
                             [name]="section.name + '_' + i + '_startDate'">
                    </div>
                    <div class="field">
                      <label>Date de fin</label>
                      <input type="date" 
                             [(ngModel)]="item.endDate"
                             [name]="section.name + '_' + i + '_endDate'">
                      <div class="checkbox-field">
                        <input type="checkbox" 
                               [(ngModel)]="item.current"
                               [name]="section.name + '_' + i + '_current'">
                        <label>En cours</label>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- Autres champs -->
                <ng-container *ngIf="field.name !== 'dates'">
                  <input *ngIf="field.type === 'text'" 
                         type="text"
                         [(ngModel)]="item[field.name]"
                         [name]="section.name + '_' + i + '_' + field.name">
                  
                  <textarea *ngIf="field.type === 'textarea'"
                           [(ngModel)]="item[field.name]"
                           [name]="section.name + '_' + i + '_' + field.name">
                  </textarea>
                </ng-container>
              </ng-container>

              <!-- Champs fichier -->
              <ng-container *ngIf="field.type === 'file'">
                <!-- Champ fichier -->
                <div *ngIf="field.type === 'file'" class="file-field">
                  <input type="file"
                         [id]="section.name + '_' + field.name"
                         (change)="onFileChange($event, section.name, field.name, i)"
                         [accept]="field.name === 'photo' ? 'image/*' : 'image/*,.pdf'">
                
                  <!-- Preview avec bouton de suppression -->
                  <div class="file-preview" *ngIf="getFieldValue(section.name, field.name, i)?.content">
                    <img *ngIf="isImage(getFieldValue(section.name, field.name, i))"
                         [src]="getFieldValue(section.name, field.name, i).content"
                         [alt]="field.label">
                    <div *ngIf="isPDF(getFieldValue(section.name, field.name, i))"
                         class="pdf-preview">PDF uploaded</div>
                    <button type="button" class="remove-file" 
                            (click)="removeFile(section.name, field.name, i)">
                      âœ•
                    </button>
                  </div>
                </div>
              </ng-container>
            </div>

            <button type="button" class="remove-btn" (click)="removeItem(section.name, i)">
              Supprimer
            </button>
          </div>

          <button type="button" class="add-btn" (click)="addItem(section.name)">
            + Ajouter {{ section.label }}
          </button>
        </ng-container>
      </div>
    </div>

    <button type="submit">Voir mon portfolio</button>
  </form>
</div>

